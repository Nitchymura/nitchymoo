{"version":3,"names":[],"mappings":"","sources":["post-like.js"],"sourcesContent":["// public/js/post-like.js\r\ndocument.addEventListener('click', async function (event) {\r\n  const button = event.target.closest('.like-button');\r\n  if (!button) return;\r\n\r\n  // デバッグ：ここが出なければJSが読まれていません\r\n  // console.log('like-button clicked');\r\n\r\n  const postId    = button.getAttribute('data-id');\r\n  const toggleUrl = button.getAttribute('data-url') || `/posts/${postId}/toggle-like`;\r\n  const csrfMeta  = document.querySelector('meta[name=\"csrf-token\"]');\r\n  const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : '';\r\n\r\n  const wasLiked = button.getAttribute('data-liked') === '1';\r\n\r\n  const iconHtml = (liked) =>\r\n    liked\r\n      ? '<i class=\"fa-solid fa-heart text-danger\"></i>'\r\n      : '<i class=\"fa-regular fa-heart text-dark\"></i>';\r\n\r\n  const updateAllIcons = (liked) => {\r\n    document.querySelectorAll(`.like-button[data-id=\"${postId}\"] .like-icon`)\r\n      .forEach(c => { c.innerHTML = iconHtml(liked); });\r\n  };\r\n  const updateAllCounts = (count) => {\r\n    document.querySelectorAll(`.like-count[data-id=\"${postId}\"]`)\r\n      .forEach(el => { el.textContent = count; });\r\n  };\r\n\r\n  const currentCountEl = document.querySelector(`.like-count[data-id=\"${postId}\"]`);\r\n  const countNow = currentCountEl ? (parseInt(currentCountEl.textContent, 10) || 0) : 0;\r\n  const optimistic = wasLiked ? Math.max(0, countNow - 1) : countNow + 1;\r\n\r\n  if (button.dataset.busy === '1') return;\r\n  button.dataset.busy = '1';\r\n\r\n  // 楽観的UI\r\n  updateAllIcons(!wasLiked);\r\n  updateAllCounts(optimistic);\r\n  document.querySelectorAll(`.like-button[data-id=\"${postId}\"]`)\r\n    .forEach(btn => btn.setAttribute('data-liked', !wasLiked ? '1' : '0'));\r\n\r\n  try {\r\n    const res = await fetch(toggleUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'X-CSRF-TOKEN': csrfToken,\r\n        'Accept': 'application/json',\r\n        'X-Requested-With': 'XMLHttpRequest',\r\n      },\r\n      body: JSON.stringify({}),\r\n      credentials: 'same-origin',\r\n    });\r\n\r\n    if (!res.ok) {\r\n      // ロールバック\r\n      updateAllIcons(wasLiked);\r\n      updateAllCounts(countNow);\r\n      document.querySelectorAll(`.like-button[data-id=\"${postId}\"]`)\r\n        .forEach(btn => btn.setAttribute('data-liked', wasLiked ? '1' : '0'));\r\n      console.error('Like toggle failed:', await res.text());\r\n      return;\r\n    }\r\n\r\n    const data = await res.json(); // { liked, like_count } を想定\r\n    if (typeof data.liked !== 'undefined') {\r\n      updateAllIcons(!!data.liked);\r\n      document.querySelectorAll(`.like-button[data-id=\"${postId}\"]`)\r\n        .forEach(btn => btn.setAttribute('data-liked', data.liked ? '1' : '0'));\r\n    }\r\n    if (typeof data.like_count !== 'undefined') {\r\n      updateAllCounts(parseInt(data.like_count, 10));\r\n    }\r\n  } catch (err) {\r\n    updateAllIcons(wasLiked);\r\n    updateAllCounts(countNow);\r\n    document.querySelectorAll(`.like-button[data-id=\"${postId}\"]`)\r\n      .forEach(btn => btn.setAttribute('data-liked', wasLiked ? '1' : '0'));\r\n    console.error('AJAX Error:', err);\r\n  } finally {\r\n    delete button.dataset.busy;\r\n  }\r\n});\r\n"],"file":"post-like.js"}