{"version":3,"names":[],"mappings":"","sources":["follow.js"],"sourcesContent":["//follow.js\r\n\r\n// public/js/follow.js\r\ndocument.addEventListener(\"DOMContentLoaded\", () => {\r\n  const busyForms = new WeakSet();\r\n\r\n  document.body.addEventListener(\"click\", async (e) => {\r\n    const followBtn = e.target.closest(\".follow-btn\");\r\n    if (!followBtn) return;\r\n\r\n    e.preventDefault();\r\n\r\n    const form = followBtn.closest(\".follow-form\");\r\n    if (!form) return;\r\n\r\n    if (busyForms.has(form)) return;\r\n    busyForms.add(form);\r\n    followBtn.disabled = true;\r\n\r\n    const url    = form.action;\r\n    const token  = form.querySelector('input[name=\"_token\"]').value;\r\n    const userId = form.dataset.userId;\r\n\r\n    try {\r\n      const res = await fetch(url, {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n          \"X-CSRF-TOKEN\": token,\r\n          \"Accept\": \"application/json\",\r\n          \"X-Requested-With\": \"XMLHttpRequest\",\r\n        },\r\n        body: JSON.stringify({}),\r\n        credentials: \"same-origin\",\r\n      });\r\n\r\n      if (!res.ok) {\r\n        console.error(\"toggle-follow失敗:\", res.status, await res.text());\r\n        return;\r\n      }\r\n\r\n      const data = await res.json(); // 期待: { following: true|false }\r\n      const following = data?.following;\r\n\r\n      // following が boolean で返ってこないと、ここで止まる\r\n      if (typeof following !== \"boolean\") {\r\n        console.error(\"不正なレスポンス:\", data);\r\n        return;\r\n      }\r\n\r\n      // 同じユーザーIDのボタンを全部更新\r\n      document\r\n        .querySelectorAll(`form.follow-form[data-user-id=\"${userId}\"] .follow-btn`)\r\n        .forEach((btn) => {\r\n          btn.classList.remove(\"btn-primary\", \"btn-outline-secondary\");\r\n          const label = btn.querySelector(\".label\") || btn;\r\n          if (following) {\r\n            btn.classList.add(\"btn-outline-secondary\");\r\n            label.textContent = \"Following\";\r\n          } else {\r\n            btn.classList.add(\"btn-primary\");\r\n            label.textContent = \"Follow\";\r\n          }\r\n        });\r\n    } catch (err) {\r\n      console.error(\"FOLLOW JS error:\", err);\r\n    } finally {\r\n      busyForms.delete(form);\r\n      followBtn.disabled = false;\r\n    }\r\n  });\r\n});"],"file":"follow.js"}